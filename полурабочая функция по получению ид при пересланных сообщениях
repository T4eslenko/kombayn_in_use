def get_message_info(message):
    # Получение информации о сообщении
    if message is None:
        return None, None, None, None, None, None, None
    user_id = None
    username = None
    first_name = None
    last_name = None
    date = None
    text = None
    
    if isinstance(message, Message):
        user_id = message.sender_id if isinstance(message.sender, User) else None
        username = message.sender.username if isinstance(message.sender, User) else None
        first_name = message.sender.first_name if isinstance(message.sender, User) else None
        last_name = message.sender.last_name if isinstance(message.sender, User) else None
        date = message.date
        text = message.text
    elif isinstance(message.fwd_from, MessageFwdHeader):
        user_id = message.fwd_from.from_id.user_id
        date = message.fwd_from.date
    return user_id, username, first_name, last_name, date, text

def get_messages_and_save_xcls(client, index: int, id_: bool, name: bool, group_title, userid, userinfo):
    wb = Workbook()
    ws = wb.active
    ws.cell(row=1, column=1, value=userinfo)
    ws.cell(row=2, column=1, value=group_title)
    ws.append(['ID объекта', 'Group ID', 'Message ID', 'Date and Time', 'User ID', '@Username', 'First Name', 'Last Name', 'Message', 'Reply to Message', 'Reply to User ID', '@Reply Username', 'Reply First Name', 'Reply Last Name', 'Reply Message ID', 'Reply Date and Time', 'Forwarded From User ID'])
    participants_from_messages = set()
    for message in client.iter_messages(group_title):
        print(message)
        input()
        # Проверяем, что message является экземпляром Message
        if not isinstance(message, Message):
            continue
        # Основная информация о сообщении
        user_id, username, first_name, last_name, date, text = get_message_info(message)
        if date is None:
            continue
        
        forwarded_from_user_id = None
        if message.forward:
            forwarded_from_user_id = message.forward.from_id.user_id
        
        row_data = [
            userid,
            message.chat_id,
            message.id,
            remove_timezone(date),
            user_id,
            f"@{username}" if username else None,
            first_name,
            last_name,
            text,
            None, None, None, None, None, None, None, None,  # Добавленные пустые столбцы для пересланных сообщений
            forwarded_from_user_id  # Идентификатор первоначального отправителя для пересланных сообщений
        ]
        participants_from_messages.add(user_id)  # Проверить, нужно ли добавлять этот ID

        ws.append(row_data)
